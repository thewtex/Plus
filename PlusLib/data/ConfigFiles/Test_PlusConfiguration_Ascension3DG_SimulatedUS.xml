<PlusConfiguration version="2.0">

  <DataCollection StartupDelaySec="1.0">
    <DeviceSet 
      Name="Simulated ultrasound image with Ascension3DG tracking of Probe (dummy) + Reference + Stylus"
      Description="Ascension3DG sensors should be plugged in to the Ascension3DG DriveBay mounted on SonixTouch in the following order from to leftmost slot (Transducer 1) to the right: 1 Probe, 2 Reference, 3 Stylus" 
    />

    <Device
      Id="TrackerDevice"
      Type="Ascension3DG"
      Frequency="15"
      LocalTimeOffset="0.0"
      FilterAcWideNotch="1">
        <Tool Name="Probe" BufferSize="2500" AveragedItemsForFiltering="20" PortName="0"></Tool>
        <Tool Name="Reference" BufferSize="2500" AveragedItemsForFiltering="20" PortName="1"></Tool>
        <Tool Name="Stylus" BufferSize="2500" AveragedItemsForFiltering="20" PortName="2"></Tool>

        <OutputStream Id="TrackerOutput" >
          <Tool Name="Probe"/>
          <Tool Name="Reference"/>
          <Tool Name="Stylus"/>
        </OutputStream>
      </Device>

    <Device
      Id="VideoDevice"
      Type="UsSimulator"
      LocalTimeOffsetSec="0.0"
      AveragedItemsForFiltering="20"
      AcquisitionRate="15"
      BufferSize="100"
      UsImageOrientation="MF" >
        <Image Id="ImageOutput" BufferSize="500" />
        
        <OutputStream Id="VideoDeviceOutput">
          <Image Id="ImageOutput"/>
        </OutputStream>
    </Device>

    <Device Id="FinalMixer" Type="VirtualStreamMixer" Selectable="True">
      <OutputStream Id="Final"/>
      <InputStream Id="TrackerOutput" />
      <InputStream Id="VideoDeviceOutput" />
    </Device>
  </DataCollection>
  
  <PlusOpenIGTLinkServer ListeningPort="18944" MaxNumberOfIgtlMessagesToSend="1" MaxTimeSpentWithProcessingMs="10"> 
    <DefaultClientInfo> 
      <MessageTypes> 
        <Message Type="IMAGE" />
        <Message Type="TRANSFORM" />
      </MessageTypes>
      <TransformNames> 
        <Transform Name="ProbeToPhantom" /> 
        <Transform Name="StylusToPhantom" /> 
      </TransformNames>
      <ImageNames>
        <Image Name="Image" EmbeddedTransformToFrame="Phantom"/>
      </ImageNames> 
    </DefaultClientInfo>
  </PlusOpenIGTLinkServer>

  <CoordinateDefinitions>
   <Transform
      From="Image" To="Probe"
      Matrix="0.0       0.084     0.0        12.5
              -0.087    0.0       0.0        51.0
              0.0       0.0       0.087      -4.3    
              0         0         0          1"
      Error="1.0" Date="022412_110829" />   
      
    <Transform
      From="Reference" To="Phantom" 
      Matrix="-0.0217475 0.0054051 0.999749  -35.3258 
              0.999619 -0.016888  0.021836  -75.1438 
              0.0170018   0.999843 -0.00503578 -24.2369 
              0          0         0          1" 
      Error="0.965947" Date="022412_105333" />
 
  </CoordinateDefinitions>

  <vtkUsSimulatorAlgo
    BackgroundValue="155"
    ImageCoordinateFrame="Image"
    ReferenceCoordinateFrame="Phantom"
    NumberOfScanlines="256"
    NumberOfSamplesPerScanline="1000"
    ModelFileName="SpineOnePieceDesign_v01.stl"
    ModelToReferenceTransform="
      1 0 0 0
      0 1 0 0
      0 0 1 0
      0 0 0 1"
  >
    <RfProcessing>
      <ScanConversion
        TransducerName="Ultrasonix_L9-4/38"
        TransducerGeometry="LINEAR"
        ImagingDepthMm="616.0"
        TransducerWidthMm="820.0"
        OutputImageSizePixel="820 616"
        OutputImageSpacingMmPerPixel="1.0 1.0"        
      />
      <xScanConversion
        TransducerName="BK_8848-axial"
        TransducerGeometry="CURVILINEAR"
        RadiusStartMm="10.0"
        RadiusStopMm="60.0"
        ThetaStartDeg="-70.0"
        ThetaStopDeg="70.0"
        OutputImageStartDepthMm="2.0"
        OutputImageSizePixel="600 400"
        OutputImageSpacingMmPerPixel="0.15 0.15"        
      />       
    </RfProcessing>  
  </vtkUsSimulatorAlgo>
</PlusConfiguration>