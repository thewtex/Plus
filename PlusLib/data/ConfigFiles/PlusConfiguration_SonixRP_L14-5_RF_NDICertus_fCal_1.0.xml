<PlusConfiguration version="1.3">

  <!-- DATA COLLECTION -->
  <DataCollection version="2.0" StartupDelaySec="1.0">
    <DeviceSet 
        Name="SonixRP L14-5 in RF mode + NDI Certus" 
        Description="Configuration file for SonixRP L14-5 in RF mode + NDI Certus + fCal 1.0
The computer needs to be on the same local network as SonixRP and the Certus SCU unit. The tools need to be plugged in the slots as following: 1: Probe, 2: Reference, 3: Stylus, 4: Needle (optional)"
        />

    <Tracker Type="CertusTracker" BufferSize="2500" Frequency="50" AveragedItemsForFiltering="20" LocalTimeOffset="0.0" >
      <Tool Name="Probe" PortName="0" Model="L14-5_38" SendTo="127.0.0.1:1111">
        <!-- ModelToToolTransform - transforming model into tool origin coordinate system for proper visualization ( Note2: All tools that are not phantoms should use ModelToToolTransform as the entity name) -->
        <Model
            File="L14-5_38_ProbeModel.stl"
            ModelToToolTransform="
          0.107721 0.979858 0.168146 -115.733132
          -0.993248 0.113395 -0.024487 13.708913
          -0.043061 -0.164373 0.985458 -107.578262
          0 0 0 1"
            />
      </Tool>

      <Tool Name="Reference" PortName="1" SendTo="127.0.0.1:1111"/>

      <Tool Name="Stylus" PortName="2" Model="Example" SendTo="127.0.0.1:1112">
        <!-- ModelToToolTransform - transforming model into tool origin coordinate system for proper visualization ( Note2: All tools that are not phantoms should use ModelToToolTransform as the entity name) -->
        <Model
            File="Stylus_Example.stl"
            ModelToToolTransform="
          1 0 0 -210.0
          0 1 0 0
          0 0 1 0
          0 0 0 1"
            />
      </Tool>

      <Tool Name="Needle" PortName="3" Model="Example"  SendTo="127.0.0.1:1112">
        <!-- ModelToToolTransform - transforming model into tool origin coordinate system for proper visualization ( Note2: All tools that are not phantoms should use ModelToToolTransform as the entity name) -->
        <Model
            File=""
            ModelToToolTransform="
          1 0 0 0
          0 1 0 0
          0 0 1 0
          0 0 0 1"
            />
      </Tool>
    </Tracker>

    <ImageAcquisition Type="SonixVideo" 
        IP="130.15.7.212" 
        BufferSize="500" 
        FrameSize="640 480"
        UsImageOrientation="UF"
        FrameRate="30" 
        AveragedItemsForFiltering="20" 
        LocalTimeOffset="-0.2126"
        ImagingMode="RfMode"
        AcquisitionDataType="RF"
        Depth="-1" 
        Sector="-1" 
        Gain="-1" 
        DynRange="-1" 
        Zoom="-1" 
        Frequency="-1" 
        Timeout="-1" 
        CompressionStatus="0" 
        />

    <Synchronization Type="ChangeDetection" 
        SynchronizationTimeLength="30" 
        MinNumOfSyncSteps="5" 
        ThresholdMultiplier="5"

        NumberOfAveragedTransforms="20" 
        MinTransformThreshold="2.0" 
        MaxTransformDifference="2.0" 

        NumberOfAveragedFrames="6" 
        MinFrameThreshold="200.0" 
        MaxFrameDifference="10.0" 
        />
  </DataCollection>

  <!-- CALIBRATION -->
  <USCalibration>
    <CalibrationController>
      <ProbeCalibration />
      <SegmentationParameters
          ApproximateSpacingMmPerPixel="0.098"
          MorphologicalOpeningCircleRadiusMm="0.55"
          MorphologicalOpeningBarSizeMm="2.0"

          RegionOfInterest="25 25 615 455"

          MaxLinePairDistanceErrorPercent="10.0"

          MaxAngleDifferenceDegrees="11"
          MinThetaDegrees="-70"
          MaxThetaDegrees="70"

          AngleToleranceDegrees="10"

          ThresholdImagePercent="10.0"

          CollinearPointsMaxDistanceFromLineMm="0.52"

          UseOriginalImageIntensityForDotIntensityScore="0"
          >
      </SegmentationParameters>
    </CalibrationController>
  </USCalibration>

  <!-- PHANTOM -->
  <PhantomDefinition version="1.1">
    <!-- Supported types are: Double-N, U-Shaped-N -->
    <Description
        Name="fCAL"
        Type="Double-N"
        Version="1.0"
        Institution="Queen's University PerkLab"
        />

    <!-- ModelToPhantomTransform - transforming model into phantom coordinate system for proper visualization -->
    <Model
        File="FCal_1.0.stl"
        ModelToPhantomTransform="
          1 0 0 -15.0
          0 1 0 10.0
          0 0 1 -5.0
          0 0 0 1"
        />

    <Geometry>
      <!-- N wire definitions -->
      <Pattern Type="NWire">
        <Wire Name="1:E3_e3" EndPointFront="20.0 0.0 5.0" EndPointBack="20.0 40.0 5.0" />
        <Wire Name="2:F3_j3" EndPointFront="25.0 0.0 5.0" EndPointBack="45.0 40.0 5.0" />
        <Wire Name="3:K3_k3" EndPointFront="50.0 0.0 5.0" EndPointBack="50.0 40.0 5.0" />
      </Pattern>
      <Pattern Type="NWire">
        <Wire Name="4:E4_e4" EndPointFront="20.0 0.0 0.0" EndPointBack="20.0 40.0 0.0" />
        <Wire Name="5:J4_f4" EndPointFront="45.0 0.0 0.0" EndPointBack="25.0 40.0 0.0" />
        <Wire Name="6:K4_k4" EndPointFront="50.0 0.0 0.0" EndPointBack="50.0 40.0 0.0" />
      </Pattern>

      <!-- Landmark list for registration -->
      <Landmarks>
        <Landmark Name="#1" Position="95.0 5.0 15.0" />
        <Landmark Name="#2" Position="95.0 40.0 15.0" />
        <Landmark Name="#3" Position="95.0 40.0 0.0" />
        <Landmark Name="#4" Position="95.0 0.0 0.0" />

        <Landmark Name="#5" Position="-25.0 40.0 15.0" />
        <Landmark Name="#6" Position="-25.0 0.0 10.0" />
        <Landmark Name="#7" Position="-25.0 0.0 0.0" />
        <Landmark Name="#8" Position="-25.0 40.0 0.0" />
      </Landmarks>
    </Geometry>
  </PhantomDefinition>

  <!-- VOLUME RECONSTRUCTION -->
  <VolumeReconstruction OutputSpacing="0.5 0.5 0.5"
      ClipRectangleOrigin="0 0" ClipRectangleSize="820 616"
      Interpolation="LINEAR" Optimization="FULL" Compounding="On" FillHoles="Off"
      />

  <fCal NumberOfCalibrationImagesToAcquire="200"
      NumberOfValidationImagesToAcquire="100"
      NumberOfStylusCalibrationPointsToAcquire="200"
      RecordingIntervalMs="100"
      MaxTimeSpentWithProcessingMs="70"
      >
    <TrackerToolNames
        Reference="Reference"
        Probe="Probe"
        Stylus="Stylus"
        />
  </fCal>

</PlusConfiguration>