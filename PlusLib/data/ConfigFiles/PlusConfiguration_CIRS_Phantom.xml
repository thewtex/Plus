<PlusConfiguration version="1.3">

	<!-- DATA COLLECTION -->
	<USDataCollection version="2.0" StartupDelaySec="1.0">
		<DeviceSet 
			Name="SonixTouch L14-5 + NDI Certus" 
			Description="Configuration file for SonixTouch L14-5 + NDI Certus + fCal 1.0" 
			/>

		<Tracker Type="CertusTracker" BufferSize="2500" Frequency="50" AveragedItemsForFiltering="20" LocalTimeOffset="0.0" >
			
			<!-- PROBE -->
			<Tool PortNumber="0" Type="Probe" Model="L14-5_38" Name="Probe" SendTo="127.0.0.1:1111">
				<!-- Supported types are: Probe, Stylus, Needle, Reference -->
				
				<!-- ModelToToolTransform - transforming model into tool origin coordinate system for proper visualization ( Note2: All tools that are not phantoms should use ModelToToolTransform as the entity name) -->
				<Model
					File="L14-5_38_ProbeModel.stl"
					ModelToToolTransform="
						0.107721 0.979858 0.168146 -115.733132
						-0.993248 0.113395 -0.024487 13.708913
						-0.043061 -0.164373 0.985458 -107.578262
						0 0 0 1"
				/>
									
				<!-- Calibration transform -->
				<Calibration
					MatrixName="ImageToProbe" 
					MatrixValue="
						1 0 0 0
						0 1 0 0
						0 0 1 0
						0 0 0 1"
					Date=""
					Error="0.0" />
			</Tool>
			
			<!-- REFERENCE -->
			<Tool Type="Reference" Name="PhantomReference" PortNumber="1" SendTo="127.0.0.1:1111">
			</Tool>

			<!-- STYLUS -->
			<Tool PortNumber="2" Type="Stylus" Model="Example" Name="Stylus" SendTo="127.0.0.1:1112">
				<!-- Supported types are: Probe, Stylus, Needle, Reference -->
				
				<!-- ModelToToolTransform - transforming model into tool origin coordinate system for proper visualization ( Note2: All tools that are not phantoms should use ModelToToolTransform as the entity name) -->
				<Model
					File="Stylus_Example.stl"
					ModelToToolTransform="
						1 0 0 -210.0
						0 1 0 0
						0 0 1 0
						0 0 0 1"
				/>
				
				<!-- Calibration transform -->
				<Calibration
					MatrixName="StylusTipToStylus" 
					MatrixValue="
						1 0 0 0
						0 1 0 0
						0 0 1 0
						0 0 0 1"
					Date=""
					Error="0.0" /> 
			</Tool>

			<!-- NEEDLE -->
			<Tool PortNumber="3" Type="Needle" Model="Example" Name="Needle" SendTo="127.0.0.1:1112">
				<!-- Supported types are: Probe, Stylus, Needle, Reference -->
				
				<!-- ModelToToolTransform - transforming model into tool origin coordinate system for proper visualization ( Note2: All tools that are not phantoms should use ModelToToolTransform as the entity name) -->
				<Model
					File=""
					ModelToToolTransform="
						1 0 0 0
						0 1 0 0
						0 0 1 0
						0 0 0 1"
				/>
				
				<!-- Calibration transform -->
				<Calibration
					MatrixName="NeedleTipToNeedle" 
					MatrixValue="
						1 0 0 0
						0 1 0 0
						0 0 1 0
						0 0 0 1"
					Date=""
					Error="0.0" />
			</Tool>
		</Tracker>

		<ImageAcquisition Type="SonixVideo" 
				BufferSize="500" 
				FrameSize="820 616" 
				UsImageOrientation="UF"
				FrameRate="30" 
				AveragedItemsForFiltering="20" 
				LocalTimeOffset="-0.2126"
				IP="130.15.7.20" 
				ImagingMode="BMode"
        AcquisitionDataType="BPost" 
				Depth="-1" 
				Sector="-1" 
				Gain="-1" 
				DynRange="-1" 
				Zoom="-1" 
				Frequency="-1" 
				Timeout="-1" 
				CompressionStatus="0" 
				/>
 
		<Synchronization Type="ChangeDetection" 
				SynchronizationTimeLength="30" 
				MinNumOfSyncSteps="5" 
				ThresholdMultiplier="5"

				NumberOfAveragedTransforms="20" 
				MinTransformThreshold="2.0" 
				MaxTransformDifference="2.0" 

				NumberOfAveragedFrames="6" 
				MinFrameThreshold="200.0" 
				MaxFrameDifference="10.0" 
				/>
	</USDataCollection>

	<!-- CALIBRATION -->
	<USCalibration>
		<CalibrationController>
			<ProbeCalibration />
			
			<SegmentationParameters
					ApproximateSpacingMmPerPixel="0.15"
					MorphologicalOpeningCircleRadiusMm="0.27"
					MorphologicalOpeningBarSizeMm="1.0"

					RegionOfInterest="243 132 666 524"

					MaxLineLengthErrorPercent="10.0"
					MaxLinePairDistanceErrorPercent="10.0"
					MaxLineErrorMm="2.0"

					MaxAngleDifferenceDegrees="11"
					MinThetaDegrees="-70"
					MaxThetaDegrees="70"

          AngleToleranceDegrees="10"
					
					InclinedLineAngleDegrees="45"
					AngleToleranceDegrees="10"
					LinePairDistMm="40"
					
					ThresholdImagePercent="19.0"

					CollinearPointsMaxDistanceFromLineMm="0.41"

					UseOriginalImageIntensityForDotIntensityScore="0"
					>
			</SegmentationParameters>
		</CalibrationController>
	</USCalibration>
	
	<!-- PHANTOM -->
	<PhantomDefinition version="1.1">
		<!-- Supported types are: Double-N, U-Shaped-N -->
		<Description
			Name="fCAL"
			Type="Double-N"
			Version="1.0"
			Institution="Queen's University PerkLab"
		/>
		
		<!-- ModelToPhantomTransform - transforming model into phantom coordinate system for proper visualization -->
		<Model
			File="FCal_1.0.stl"
			ModelToPhantomTransform="
				1 0 0 -15.0
				0 1 0 10.0
				0 0 1 -5.0
				0 0 0 1"
		/>

		<Geometry>
			<!-- Pattern definitions -->
			<Pattern Type="CoplanarParallelWires" Id="0">
				<Wire Id="0" Name="F1" EndPointFront="60.65 38.0 3.0" EndPointBack="60.65 38.0 103.0" />
				<Wire Id="1" Name="F2" EndPointFront="60.65 48.0 3.0" EndPointBack="60.65 48.0 103.0" />
				<Wire Id="2" Name="F3" EndPointFront="60.65 58.0 3.0" EndPointBack="60.65 58.0 103.0" />
				<Wire Id="3" Name="F4" EndPointFront="60.65 68.0 3.0" EndPointBack="60.65 68.0 103.0" />
				<Wire Id="4" Name="F5" EndPointFront="60.65 78.0 3.0" EndPointBack="60.65 78.0 103.0" />
			</Pattern>
			<Pattern Type="CoplanarParallelWires" Id="1">
				<Wire Id="0" Name="F5" EndPointFront="60.65 78.0 3.0" EndPointBack="60.65 78.0 103.0" />
				<Wire Id="1" Name="E4" EndPointFront="70.65 68.0 3.0" EndPointBack="70.65 68.0 103.0" />
				<Wire Id="2" Name="D3" EndPointFront="80.65 58.0 3.0" EndPointBack="80.65 58.0 103.0" />
				<Wire Id="3" Name="C2" EndPointFront="90.65 48.0 3.0" EndPointBack="90.65 48.0 103.0" />
				<Wire Id="4" Name="B1" EndPointFront="100.65 38.0 3.0" EndPointBack="100.65 38.0 103.0" />
			</Pattern>
			<Pattern Type="CoplanarParallelWires" Id="2">
				<Wire Id="0" Name="B1" EndPointFront="100.65 38.0 3.0" EndPointBack="100.65 38.0 103.0" />
				<Wire Id="1" Name="B2" EndPointFront="100.65 48.0 3.0" EndPointBack="100.65 48.0 103.0" />
				<Wire Id="2" Name="B3" EndPointFront="100.65 58.0 3.0" EndPointBack="100.65 58.0 103.0" />
				<Wire Id="3" Name="B4" EndPointFront="100.65 68.0 3.0" EndPointBack="100.65 68.0 103.0" />
				<Wire Id="4" Name="B5" EndPointFront="100.65 78.0 3.0" EndPointBack="100.65 78.0 103.0" />
			</Pattern>

			<!-- Landmark list for registration -->
			<Landmarks>
				<Landmark Name="#0" Position="100.65 78.0 0.0" />
				<Landmark Name="#1" Position="60.65 38.0 0.0" />
				
				<Landmark Name="#2" Position="100.65 38.0 106.0" />
				<Landmark Name="#3" Position="60.65 78.0 106.0" />
				
				<Landmark Name="#4" Position="0.0 68.0 33.0" />
				
				<Landmark Name="#5" Position="156.30 68.0 73.0" />
			</Landmarks>
			
			<Registration
				MatrixName="PhantomToPhantomReference" 
				MatrixValue="
					1 0 0 0
					0 1 0 0
					0 0 1 0
					0 0 0 1" 
				Date=""
				Error="0.0" />
		</Geometry>
	</PhantomDefinition>

	<!-- VOLUME RECONSTRUCTION -->
  <VolumeReconstruction OutputSpacing="0.5 0.5 0.5"
                        ClipRectangleOrigin="0 0" ClipRectangleSize="820 616"
                        Interpolation="LINEAR" Optimization="FULL" Compounding="On" FillHoles="Off"/>

</PlusConfiguration>