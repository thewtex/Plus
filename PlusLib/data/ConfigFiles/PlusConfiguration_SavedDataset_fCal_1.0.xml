<PlusConfiguration version="1.3">

  <DataCollection version="2.0" StartupDelaySec="1.0">
    <DeviceSet 
      Name="Saved dataset for both video and tracking (fCal)" 
      Description="Configuration file for Saved dataset + fCal 1.0
It loads an fCal test image, but it can be changed by modifying the SequenceMetafile attributes (absolute path is needed if the image is not in the test image directory"
    />

    <Tracker Type="SavedDataset" BufferSize="2500" Frequency="10" AveragedItemsForFiltering="20" LocalTimeOffset="0.0"
      SequenceMetafile="fCal_Test_Calibration.mha"
      ReplayEnabled="TRUE"
    >
      <Tool Name="Probe" PortName="0" Model="L14-5_38" SendTo="127.0.0.1:1111" />
      <Tool Name="Reference" PortName="1" SendTo="127.0.0.1:1111" />
      <Tool Name="Stylus" PortName="2" Model="Example" SendTo="127.0.0.1:1112" />
    </Tracker>

    <ImageAcquisition Type="SavedDataset" 
      BufferSize="200" 
      FrameSize="820 616" 
      FrameRate="10" 
      AveragedItemsForFiltering="20" 
      LocalTimeOffset="0.0" 
      SequenceMetafile="fCal_Test_Calibration.mha"
      UsImageOrientation="MF"
      ReplayEnabled="TRUE"
    />

    <Synchronization Type="ChangeDetection" 
      SynchronizationTimeLength="30" 
      MinNumOfSyncSteps="5" 
      ThresholdMultiplier="5"

      NumberOfAveragedTransforms="20" 
      MinTransformThreshold="2.0" 
      MaxTransformDifference="2.0" 

      NumberOfAveragedFrames="6" 
      MinFrameThreshold="200.0" 
      MaxFrameDifference="10.0" 
    />
  </DataCollection>


  <CoordinateDefinitions>
    <Transform From="Phantom" To="Reference"
      Matrix="0.9968 0.0075 -0.0795 -35.6089
              0.0794 0.0055 0.9968 -124.9852
              0.0079 -1.0000 0.0049 -16.7
              0 0 0 1"
      Date="2011.12.01 17:57:00" Error="0.0"/>
    
    <Transform From="Image" To="TransducerOriginPixel"
      Matrix="1 0 0 410
              0 1 0 5
              0 0 1 0
              0 0 0 1"
      Date="2011.12.06 17:57:00" Error="0.0" />    
  </CoordinateDefinitions> 


  <Rendering
    WorldCoordinateFrame="Reference"
  >
    <DisplayableObject ObjectCoordinateFrame="TransducerOrigin">
      <Model
        File="L14-5_38_ProbeModel.stl"
        ModelToObjectTransform="
          1 0 0 0
          0 1 0 66.0
          0 0 1 0
          0 0 0 1"
      />
    </DisplayableObject>

    <DisplayableObject ObjectCoordinateFrame="StylusTip">
      <Model
        File="Stylus_Example.stl"
        ModelToObjectTransform="
          1 0 0 -210.0
          0 1 0 0
          0 0 1 0
          0 0 0 1"
      />
    </DisplayableObject>

    <DisplayableObject ObjectCoordinateFrame="Phantom">
      <Model
        File="FCal_1.0.stl"
        ModelToObjectTransform="
          1 0 0 -15.0
          0 1 0 10.0
          0 0 1 -5.0
          0 0 0 1"
      />
    </DisplayableObject>

    <DisplayableObject ObjectCoordinateFrame="Image">
      <Image />
    </DisplayableObject>

  </Rendering>


  <Segmentation
    ApproximateSpacingMmPerPixel="0.078"
    MorphologicalOpeningCircleRadiusMm="0.47"
    MorphologicalOpeningBarSizeMm="1.0"
    RegionOfInterest="27 27 793 589"
    MaxLinePairDistanceErrorPercent="10.0"
    MaxAngleDifferenceDegrees="11"
    MinThetaDegrees="-70"
    MaxThetaDegrees="70"
    AngleToleranceDegrees="10"
    ThresholdImagePercent="10.0"
    CollinearPointsMaxDistanceFromLineMm="0.41"
    UseOriginalImageIntensityForDotIntensityScore="0"
  />


  <PhantomDefinition version="1.1">
    <!-- Supported types are: Double-N, U-Shaped-N -->
    <Description
      Name="fCAL"
      Type="Double-N"
      Version="1.0"
      WiringVersion="1.0"
      Institution="Queen's University PerkLab"
    />

    <Geometry>
      <Pattern Type="NWire">
        <Wire Name="1:E3_e3" EndPointFront="20.0 0.0 5.0" EndPointBack="20.0 40.0 5.0" />
        <Wire Name="2:F3_j3" EndPointFront="25.0 0.0 5.0" EndPointBack="45.0 40.0 5.0" />
        <Wire Name="3:K3_k3" EndPointFront="50.0 0.0 5.0" EndPointBack="50.0 40.0 5.0" />
      </Pattern>
      <Pattern Type="NWire">
        <Wire Name="4:E4_e4" EndPointFront="20.0 0.0 0.0" EndPointBack="20.0 40.0 0.0" />
        <Wire Name="5:J4_f4" EndPointFront="45.0 0.0 0.0" EndPointBack="25.0 40.0 0.0" />
        <Wire Name="6:K4_k4" EndPointFront="50.0 0.0 0.0" EndPointBack="50.0 40.0 0.0" />
      </Pattern>

      <Landmarks>
        <Landmark Name="#1" Position="95.0 5.0 15.0" />
        <Landmark Name="#2" Position="95.0 40.0 15.0" />
        <Landmark Name="#3" Position="95.0 40.0 0.0" />
        <Landmark Name="#4" Position="95.0 0.0 0.0" />

        <Landmark Name="#5" Position="-25.0 40.0 15.0" />
        <Landmark Name="#6" Position="-25.0 0.0 10.0" />
        <Landmark Name="#7" Position="-25.0 0.0 0.0" />
        <Landmark Name="#8" Position="-25.0 40.0 0.0" />
      </Landmarks>
    </Geometry>
  </PhantomDefinition>


  <VolumeReconstruction OutputSpacing="0.5 0.5 0.5"
    ClipRectangleOrigin="0 0" ClipRectangleSize="820 616"
    Interpolation="LINEAR" Optimization="FULL" Compounding="On" FillHoles="Off"
  />


  <fCal
    NumberOfCalibrationImagesToAcquire="200"
    NumberOfValidationImagesToAcquire="100"
    NumberOfStylusCalibrationPointsToAcquire="200"
    RecordingIntervalMs="100"
    MaxTimeSpentWithProcessingMs="70"
    ProbeCoordinateFrame="Probe"
    ReferenceCoordinateFrame="Reference"
  />


  <vtkPivotCalibrationAlgo
    ObjectMarkerCoordinateFrame="Stylus"
    ReferenceCoordinateFrame="Reference"
    ObjectPivotPointCoordinateFrame="StylusTip"
  />


  <vtkPhantomRegistrationAlgo
    PhantomCoordinateFrame="Phantom"
    ReferenceCoordinateFrame="Reference"
    StylusTipCoordinateFrame="StylusTip"
  />


  <vtkProbeCalibrationAlgo
    ImageCoordinateFrame="Image"
    ProbeCoordinateFrame="Probe"
    PhantomCoordinateFrame="Phantom"
    ReferenceCoordinateFrame="Reference"
    TransducerOriginCoordinateFrame="TransducerOrigin"
    TransducerOriginPixelCoordinateFrame="TransducerOriginPixel"
  />

</PlusConfiguration>