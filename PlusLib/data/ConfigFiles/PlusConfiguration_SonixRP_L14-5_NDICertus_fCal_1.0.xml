<PlusConfiguration version="1.2">

	<!-- DATA COLLECTION -->
	<USDataCollection version="2.0" StartupDelaySec="1.0">
		<DeviceSet 
			Name="Unified SonixRP L14-5 + NDI Certus" 
			Description="Unified configuration file for SonixRP L14-5 + NDI Certus + fCal 1.0" 
			/>

		<Tracker Type="CertusTracker" BufferSize="2500" Frequency="50" AveragedItemsForFiltering="20" LocalTimeOffset="0.0" >
			
			<!-- PROBE -->
			<Tool PortNumber="0" Type="Probe" Model="L14-5_38" Name="Probe" SendTo="127.0.0.1:1111">
				<!-- Supported types are: Probe, Stylus, Needle, Reference -->
				
				<!-- ModelToToolTransform - transforming model into tool origin coordinate system for proper visualization ( Note2: All tools that are not phantoms should use ModelToToolTransform as the entity name) -->
				<Model
					File="L14-5_38_ProbeModel.stl"
					ModelToToolTransform="
						1 0 0 29.2
						0 1 0 0
						0 0 1 14.2
						0 0 0 1"
				/>
									
				<!-- Calibration transform -->
				<Calibration
					MatrixName="ImageToProbe" 
					MatrixValue="
						1 0 0 0
						0 1 0 0
						0 0 1 0
						0 0 0 1"
					Date="2011.07.28 21:42:34"
					Error="0.0" />
			</Tool>
			
			<!-- REFERENCE -->
			<Tool Type="Reference" Name="PhantomReference" PortNumber="1" SendTo="127.0.0.1:1111">
			</Tool>

			<!-- STYLUS -->
			<Tool PortNumber="2" Type="Stylus" Model="Example" Name="Stylus" SendTo="127.0.0.1:1112">
				<!-- Supported types are: Probe, Stylus, Needle, Reference -->
				
				<!-- ModelToToolTransform - transforming model into tool origin coordinate system for proper visualization ( Note2: All tools that are not phantoms should use ModelToToolTransform as the entity name) -->
				<Model
					File="Stylus_Example.stl"
					ModelToToolTransform="
						1 0 0 -210.0
						0 1 0 0
						0 0 1 0
						0 0 0 1"
				/>
				
				<!-- Calibration transform -->
				<Calibration
					MatrixName="StylusTipToStylus" 
					MatrixValue="
						1 0 0 210.0474
						0 1 0 -0.0521
						0 0 1 -0.0000
						0 0 0 1"
					Date="2011.07.29 17:22:12"
					Error="0.561812" /> 
			</Tool>

			<!-- NEEDLE -->
			<Tool PortNumber="3" Type="Needle" Model="Example" Name="Needle" SendTo="127.0.0.1:1112">
				<!-- Supported types are: Probe, Stylus, Needle, Reference -->
				
				<!-- ModelToToolTransform - transforming model into tool origin coordinate system for proper visualization ( Note2: All tools that are not phantoms should use ModelToToolTransform as the entity name) -->
				<Model
					File=""
					ModelToToolTransform="
						1 0 0 0
						0 1 0 0
						0 0 1 0
						0 0 0 1"
				/>
				
				<!-- Calibration transform -->
				<Calibration
					MatrixName="NeedleTipToNeedle" 
					MatrixValue="
						1 0 0 0
						0 1 0 0
						0 0 1 0
						0 0 0 1"
					Date="2011.07.28 21:42:34"
					Error="0.0" />
			</Tool>
		</Tracker>

		<ImageAcqusition Type="SonixVideo" 
				IP="130.15.7.212" 
				BufferSize="500" 
				FrameSize="640 480"
				UsImageOrientation="UF"
				FrameRate="30" 
				AveragedItemsForFiltering="20" 
				LocalTimeOffset="-0.2126"
				ImagingMode="0" 
				AcquisitionDataType="4" 
				Depth="-1" 
				Sector="-1" 
				Gain="-1" 
				DynRange="-1" 
				Zoom="-1" 
				Frequency="-1" 
				Timeout="-1" 
				CompressionStatus="0" 
				/>

		<Synchronization Type="ChangeDetection" 
				SynchronizationTimeLength="30" 
				MinNumOfSyncSteps="5" 
				ThresholdMultiplier="5"

				NumberOfAveragedTransforms="20" 
				MinTransformThreshold="2.0" 
				MaxTransformDifference="2.0" 

				NumberOfAveragedFrames="6" 
				MinFrameThreshold="200.0" 
				MaxFrameDifference="10.0" 
				/>
	</USDataCollection>

	<!-- CALIBRATION -->
	<USCalibration version="1.0">
		<!-- CalibrationMode: OFFLINE or REALTIME -->
		<CalibrationController LogLevel="INFO" OutputPath="./Output" EnableTrackedSequenceDataSaving="FALSE" EnableErroneouslySegmentedDataSaving="FALSE" EnableSegmentationAnalysis="FALSE" CalibrationMode="REALTIME" EnableVisualization="FALSE">
			<StepperCalibration MinNumberOfRotationClusters="4" >
				<!-- TemplateTranslationData: These are the data files used to calculate the template translation axis  -->
				<TemplateTranslationData 
						NumberOfImagesToUse="100" 
						StartingIndex="0" 
						SequenceMetaFile="\\image\shared_data\images\TRUSCalibration\2011-02-09_iCALDemo_TestData\TemplateTranslationData.mha"
						/>

				<!-- ProbeTranslationData: These are the data files used to calculate the stepper translation axis  -->
				<ProbeTranslationData 
						NumberOfImagesToUse="200" 
						StartingIndex="0" 
						SequenceMetaFile="\\image\shared_data\images\TRUSCalibration\2011-02-09_iCALDemo_TestData\ProbeTranslationData.mha"
						/>
				
				 <!-- ProbeRotationData: These are the data files used to calculate the frame center of rotation  -->
				<ProbeRotationData 
						NumberOfImagesToUse="500" 
						StartingIndex="0" 
						SequenceMetaFile="\\image\shared_data\images\TRUSCalibration\2011-02-09_iCALDemo_TestData\ProbeRotationData.mha"
						/>
			</StepperCalibration>	
			
			<ProbeCalibration
					EnableLogFile="FALSE"  
					EnableSegmentedWirePositionsSaving="FALSE"
					ImageHomeToUserImageHomeTransform=" 1  0  0  0 
														0  1  0  0 
														0  0  1  0 
														0  0  0  1"
					DataFileSuffix=".data"
					CalibrationResultFileSuffix=".Calibration.results"
					SegmentationErrorLogFileNameSuffix=".Segmentation.errors"
					SegmentationAnalysisFileNameSuffix = ".Segmentation.analysis"
					Temp2StepCalibAnalysisFileNameSuffix = ".Template2StepperCalibration.analysis"
					>
				
				 <!-- RandomStepperMotionData1: These are the data files used for calibration. -->
				<RandomStepperMotionData1
						NumberOfImagesToUse="300" 
						StartingIndex="0" 
						SequenceMetaFile="\\image\shared_data\images\TRUSCalibration\2011-02-09_iCALDemo_TestData\RandomStepperMotionData1.mha"
						/>

				<!-- RandomStepperMotionData2: These are the data files used to validate the calibration accuracy.  -->
				<RandomStepperMotionData2
						NumberOfImagesToUse="200" 
						StartingIndex="0" 
						SequenceMetaFile="\\image\shared_data\images\TRUSCalibration\2011-02-09_iCALDemo_TestData\RandomStepperMotionData2.mha"
						/>

				<TemplateModel ConfigFile="../config/TemplateModel.xml" >
				</TemplateModel>

				<!-- IncorporatingUS3DBeamProfile: 0 - NO | 1 - BeamwidthVariance | 2 - BeamwidthRatio | 3 - BeamwidthVarianceAndThresholding -->
				<!-- ConfigFile: The name and the relative or absolute path of the US beam profile file -->
				<US3DBeamProfile IncorporatingUS3DBeamProfile="0" ConfigFile="./Component_US3DBeamProfile.config" />
			</ProbeCalibration>
			
			<RealtimeCalibration>
				<!-- TemplateTranslationData: These are the data files used to calculate the template translation axis  -->
				<TemplateTranslationData 
						NumberOfImagesToAcquire="100" 
						OutputSequenceMetaFileSuffix=".TemplateTranslationData"
						/>
				<!-- ProbeTranslationData: These are the data files used to calculate the stepper translation axis  -->
				<ProbeTranslationData 
						NumberOfImagesToAcquire="200" 
						OutputSequenceMetaFileSuffix=".ProbeTranslationData"
						/>
				 <!-- ProbeRotationData: These are the data files used to calculate the frame center of rotation  -->
				<ProbeRotationData 
						NumberOfImagesToAcquire="500" 
						OutputSequenceMetaFileSuffix=".ProbeRotationData"
						/>
				 <!-- RandomStepperMotionData1: These are the data files used for calibration. -->
				<RandomStepperMotionData1
						NumberOfImagesToAcquire="200" 
						OutputSequenceMetaFileSuffix=".RandomStepperMotionData1"
						/>
				<!-- RandomStepperMotionData2: These are the data files used to validate the calibration accuracy.  -->
				<RandomStepperMotionData2
						NumberOfImagesToAcquire="100" 
						OutputSequenceMetaFileSuffix=".RandomStepperMotionData2"
						/>
				<!-- FreehandMotionData1: These are the data files used for calibration. -->
				<FreehandMotionData1
						NumberOfImagesToAcquire="200" 
						OutputSequenceMetaFileSuffix=".FreehandMotionData1"
						/>
				<!-- FreehandMotionData2: These are the data files used to validate the calibration accuracy.  -->
				<FreehandMotionData2
						NumberOfImagesToAcquire="100" 
						OutputSequenceMetaFileSuffix=".FreehandMotionData2"
						/>
			</RealtimeCalibration>
			
			<PhantomDefinition FileName="PhantomDefinition_fCal_1.0_Wiring_1.0.xml" /> 

			<!-- SearchRegionX: X-axis points to the right in pixels (there must be at least 8-pixel-wide black border outside of the search region.) -->
			<!-- SearchRegionY: Y-axis points to the bottom in pixels (there must be at least 8-pixel-wide black border outside of the search region.) -->
			<SegmentationParameters
					FrameSize="640 480"
					ScalingEstimation="0.098"
					MorphologicalOpeningCircleRadiusMm="0.55"
					MorphologicalOpeningBarSizeMm="2.0"

					RegionOfInterest="25 25 615 455"

					MaxLineLengthErrorPercent="10.0"
					MaxLinePairDistanceErrorPercent="10.0"
					MaxLineErrorMm="2.0"

					MaxAngleDifferenceDegrees="11"
					MinThetaDegrees="20"
					MaxThetaDegrees="160"
					
					ThresholdImageTop="10.0"
					ThresholdImageBottom="10.0"

					FindLines3PtDist="5.3"

					UseOriginalImageIntensityForDotIntensityScore="0"

					>
			</SegmentationParameters>
		</CalibrationController>
	</USCalibration>
	
	<!-- PHANTOM -->
	<PhantomDefinition version="1.0">
		<!-- Supported types are: Double-N, U-Shaped-N -->
		<Description
			Name="fCAL"
			Type="Double-N"
			Version="1.0"
			Institution="Queen's University PerkLab"
		/>
		
		<!-- ModelToPhantomTransform - transforming model into phantom coordinate system for proper visualization -->
		<Model
			File="FCal_1.0.stl"
			ModelToPhantomTransform="
				1 0 0 -15.0
				0 1 0 10.0
				0 0 1 -5.0
				0 0 0 1"
		/>

		<Geometry>
			<!-- N wire definitions -->
			<NWire>
				<Wire Id="1" Name="E3_e3" EndPointFront="20.0 0.0 5.0" EndPointBack="20.0 40.0 5.0" />
				<Wire Id="2" Name="F3_j3" EndPointFront="25.0 0.0 5.0" EndPointBack="45.0 40.0 5.0" />
				<Wire Id="3" Name="K3_k3" EndPointFront="50.0 0.0 5.0" EndPointBack="50.0 40.0 5.0" />
			</NWire>
			<NWire>
				<Wire Id="4" Name="E4_e4" EndPointFront="20.0 0.0 0.0" EndPointBack="20.0 40.0 0.0" />
				<Wire Id="5" Name="J4_f4" EndPointFront="45.0 0.0 0.0" EndPointBack="25.0 40.0 0.0" />
				<Wire Id="6" Name="K4_k4" EndPointFront="50.0 0.0 0.0" EndPointBack="50.0 40.0 0.0" />
			</NWire>

			<!-- Landmark list for registration -->
			<Landmarks>
				<Landmark Name="#1" Position="95.0 5.0 15.0" />
				<Landmark Name="#2" Position="95.0 40.0 15.0" />
				<Landmark Name="#3" Position="95.0 40.0 0.0" />
				<Landmark Name="#4" Position="95.0 0.0 0.0" />
				
				<Landmark Name="#5" Position="-25.0 40.0 15.0" />
				<Landmark Name="#6" Position="-25.0 0.0 10.0" />
				<Landmark Name="#7" Position="-25.0 0.0 0.0" />
				<Landmark Name="#8" Position="-25.0 40.0 0.0" />
			</Landmarks>
			
			<Registration
				MatrixName="PhantomToPhantomReference" 
				MatrixValue="
					0.9968 0.0075 -0.0795 -35.6089
					0.0794 0.0055 0.9968 -124.9852
					0.0079 -1.0000 0.0049 -16.7
					0 0 0 1" 
				Date="2011.07.20 15:09:35"
				Error="-1.0" />
		</Geometry>
	</PhantomDefinition>

	<!-- VOLUME RECONSTRUCTION -->
	<VolumeReconstruction>
		<SliceParameters SliceSpacing="1 1 1" SliceOrigin="0 0 0" NumScalarComponents="1" />

		<OutputParameters OutputSpacing="0.5 0.5 0.5" />

		<ClippingParameters ClipRectangle="0 0 820 616"/>
		<FanParameters FanAngles="0 0" FanOrigin="0 0" FanDepth="300"/>
		<RotationOptions ImageFlipped="Off" Rotation="Off" MaxRotationChange="90" Threshold1="0" Threshold2="255" ShiftX="0" ShiftY="0" />
		<ReconstructionOptions Interpolation="Linear" Optimization="On" Compounding="On"/>
	</VolumeReconstruction>

</PlusConfiguration>