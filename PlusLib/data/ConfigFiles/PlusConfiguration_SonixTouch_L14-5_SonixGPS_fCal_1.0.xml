<PlusConfiguration version="1.2">

	<!-- DATA COLLECTION -->
	<USDataCollection version="2.0" StartupDelaySec="1.0">
	  
	  <DeviceSet 
		Name="SonixTouch with GPS extension" 
		Description="Ultrasound probe is tracked by the GPS extension against a reference sensor." 
		/>

	  <Tracker
		Type="Ascension3DG"
		BufferSize="500"
		Frequency="20"
		LocalTimeOffset="0.0"
		AveragedItemsForFiltering="20"
		>
		  
		<Tool
		  Name="Probe"
      Type="Probe"
		  PortNumber="0"
		  SendTo="localhost:18944">
			<Model
				File="L14-5_38_ProbeModel.stl"
				ModelToToolTransform="
					0.107721 0.979858 0.168146 -115.733132
					-0.993248 0.113395 -0.024487 13.708913
					-0.043061 -0.164373 0.985458 -107.578262
					0 0 0 1"
			/>
			<Calibration
				MatrixName="ImageToProbe" 
				MatrixValue="
					1 0 0 0
					0 1 0 0
					0 0 1 0
					0 0 0 1"
				Date=""
				Error="0.0" />		  
		</Tool>
		
		<Tool
		  Name="Reference"
      Type="Reference"
		  PortNumber="1">
		</Tool>
	  
		<Tool
		  Name="Stylus"
      Type="Stylus"
		  PortNumber="2">
			<Model
				File="Stylus_Example.stl"
				ModelToToolTransform="
					1 0 0 -210.0
					0 1 0 0
					0 0 1 0
					0 0 0 1"
			/>
			<Calibration
				MatrixName="StylusTipToStylus" 
				MatrixValue="
					1 0 0 0
					0 1 0 0
					0 0 1 0
					0 0 0 1"
				Date=""
				Error="0.0" />
		</Tool>
	  
	  </Tracker>

	  <ImageAcqusition
      Type="SonixVideo" 
      BufferSize="500" 
      FrameSize="820 616" 
      UsImageOrientation="UF"
      FrameRate="30" 
      AveragedItemsForFiltering="20" 
      LocalTimeOffset="-0.2976"
      IP="130.15.7.20" 
      ImagingMode="0" 
      AcquisitionDataType="4" 
      Depth="-1" 
      Sector="-1" 
      Gain="-1" 
      DynRange="-1" 
      Zoom="-1" 
      Frequency="-1" 
      Timeout="-1" 
      CompressionStatus="0" 
		/>

	  <Synchronization
      Type="ChangeDetection" 
      SynchronizationTimeLength="30" 
      MinNumOfSyncSteps="5" 
      ThresholdMultiplier="5"

      NumberOfAveragedTransforms="20" 
      MinTransformThreshold="2.0" 
      MaxTransformDifference="2.0" 

      NumberOfAveragedFrames="6" 
      MinFrameThreshold="200.0" 
      MaxFrameDifference="10.0" 
		/>
	  
	</USDataCollection>


	<!-- CALIBRATION -->
	<USCalibration version="1.0">
		<CalibrationController LogLevel="INFO" OutputPath="./Output" EnableTrackedSequenceDataSaving="FALSE" EnableErroneouslySegmentedDataSaving="FALSE" EnableSegmentationAnalysis="FALSE" >
			
			<ProbeCalibration
        EnableLogFile="FALSE"  
        EnableSegmentedWirePositionsSaving="FALSE"
        ImageHomeToUserImageHomeTransform=" 1  0  0  0 
                          0  1  0  0 
                          0  0  1  0 
                          0  0  0  1"
        DataFileSuffix=".data"
        CalibrationResultFileSuffix=".Calibration.results"
        SegmentationErrorLogFileNameSuffix=".Segmentation.errors"
        SegmentationAnalysisFileNameSuffix = ".Segmentation.analysis"
        Temp2StepCalibAnalysisFileNameSuffix = ".Template2StepperCalibration.analysis"
        >
				
        <!-- RandomStepperMotionData1: These are the data files used for calibration. -->
        <RandomStepperMotionData1
                NumberOfImagesToAcquire="200" 
                OutputSequenceMetaFileSuffix=".RandomStepperMotionData1"
                />
        <!-- RandomStepperMotionData2: These are the data files used to validate the calibration accuracy.  -->
        <RandomStepperMotionData2
                NumberOfImagesToAcquire="100" 
                OutputSequenceMetaFileSuffix=".RandomStepperMotionData2"
                />
                
				<TemplateModel ConfigFile="../config/TemplateModel.xml" >
				</TemplateModel>

				<!-- IncorporatingUS3DBeamProfile: 0 - NO | 1 - BeamwidthVariance | 2 - BeamwidthRatio | 3 - BeamwidthVarianceAndThresholding -->
				<!-- ConfigFile: The name and the relative or absolute path of the US beam profile file -->
				<US3DBeamProfile IncorporatingUS3DBeamProfile="0" ConfigFile="./Component_US3DBeamProfile.config" />
			</ProbeCalibration>
            
      <FreehandCalibration>
				<!-- FreehandMotionData1: These are the data files used for calibration. -->
				<FreehandMotionData1
						NumberOfImagesToAcquire="200" 
						OutputSequenceMetaFileSuffix=".FreehandMotionData1"
						/>
				<!-- FreehandMotionData2: These are the data files used to validate the calibration accuracy.  -->
				<FreehandMotionData2
						NumberOfImagesToAcquire="100" 
						OutputSequenceMetaFileSuffix=".FreehandMotionData2"
						/>
      </FreehandCalibration>
            
			<SegmentationParameters
					FrameSize="820 616"
					ScalingEstimation="0.078"
					MorphologicalOpeningCircleRadiusMm="0.47"
					MorphologicalOpeningBarSizeMm="1.0"

					RegionOfInterest="27 27 793 589"

					MaxLineLengthErrorPercent="10.0"
					MaxLinePairDistanceErrorPercent="10.0"
					MaxLineErrorMm="2.0"

					MaxAngleDifferenceDegrees="11"
					MinThetaDegrees="20"
					MaxThetaDegrees="160"
					
					ThresholdImage="10.0"

					FindLines3PtDist="5.3"

					UseOriginalImageIntensityForDotIntensityScore="0"
					>
			</SegmentationParameters>
		</CalibrationController>
	</USCalibration>
	
	<!-- PHANTOM -->
	<PhantomDefinition version="1.0">
		<!-- Supported types are: Double-N, U-Shaped-N -->
		<Description
			Name="fCAL"
			Type="Double-N"
			Version="1.0"
			Institution="Queen's University PerkLab"
		/>
		
		<!-- ModelToPhantomTransform - transforming model into phantom coordinate system for proper visualization -->
		<Model
			File="FCal_1.0.stl"
			ModelToPhantomTransform="
				1 0 0 -15.0
				0 1 0 10.0
				0 0 1 -5.0
				0 0 0 1"
		/>

		<Geometry>
			<!-- N wire definitions -->
			<NWire>
				<Wire Id="1" Name="E3_e3" EndPointFront="20.0 0.0 5.0" EndPointBack="20.0 40.0 5.0" />
				<Wire Id="2" Name="F3_j3" EndPointFront="25.0 0.0 5.0" EndPointBack="45.0 40.0 5.0" />
				<Wire Id="3" Name="K3_k3" EndPointFront="50.0 0.0 5.0" EndPointBack="50.0 40.0 5.0" />
			</NWire>
			<NWire>
				<Wire Id="4" Name="E4_e4" EndPointFront="20.0 0.0 0.0" EndPointBack="20.0 40.0 0.0" />
				<Wire Id="5" Name="J4_f4" EndPointFront="45.0 0.0 0.0" EndPointBack="25.0 40.0 0.0" />
				<Wire Id="6" Name="K4_k4" EndPointFront="50.0 0.0 0.0" EndPointBack="50.0 40.0 0.0" />
			</NWire>

			<!-- Landmark list for registration -->
			<Landmarks>
				<Landmark Name="#1" Position="95.0 5.0 15.0" />
				<Landmark Name="#2" Position="95.0 40.0 15.0" />
				<Landmark Name="#3" Position="95.0 40.0 0.0" />
				<Landmark Name="#4" Position="95.0 0.0 0.0" />
				
				<Landmark Name="#5" Position="-25.0 40.0 15.0" />
				<Landmark Name="#6" Position="-25.0 0.0 10.0" />
				<Landmark Name="#7" Position="-25.0 0.0 0.0" />
				<Landmark Name="#8" Position="-25.0 40.0 0.0" />
			</Landmarks>
			
			<Registration
				MatrixName="PhantomToPhantomReference" 
				MatrixValue="
					1 0 0 0
					0 1 0 0
					0 0 1 0
					0 0 0 1" 
				Date=""
				Error="0.0" />
		</Geometry>
	</PhantomDefinition>

	<!-- VOLUME RECONSTRUCTION -->
	<VolumeReconstruction>
		<SliceParameters SliceSpacing="1 1 1" SliceOrigin="0 0 0" NumScalarComponents="1" />

		<OutputParameters OutputSpacing="0.5 0.5 0.5" />

		<ClippingParameters ClipRectangle="0 0 820 616"/>
		<FanParameters FanAngles="0 0" FanOrigin="0 0" FanDepth="300"/>
		<RotationOptions ImageFlipped="Off" Rotation="Off" MaxRotationChange="90" Threshold1="0" Threshold2="255" ShiftX="0" ShiftY="0" />
		<ReconstructionOptions Interpolation="Linear" Optimization="On" Compounding="On"/>
	</VolumeReconstruction>

</PlusConfiguration>