<PlusConfiguration version="2.0">

  <DataCollection StartupDelaySec="1.0">
    <DeviceSet 
      Name="TEST UsSimulator with Saved data tracker"
      Description="Simulated ultrasound from STL model and corresponding saved tracking data" 
    />

    <Device
      Type="SavedTrackerDataset"
      Id="DeviceSavedDataset"
      AcquisitionRate="10"
      LocalTimeOffsetSec="0.0"
      SequenceMetafile="UsSimulatorAlgoTestTrackingData.mha"
      RepeatEnabled="TRUE"
    >
      <Tool Name="Probe" PortName="0" Model="L14-5_38" BufferSize="2500" AveragedItemsForFiltering="20"/>
      <Tool Name="Reference" PortName="1" BufferSize="2500" AveragedItemsForFiltering="20"/>
      <Tool Name="Stylus" PortName="2" Model="Example" BufferSize="2500" AveragedItemsForFiltering="20"/>
      
      <OutputStream Id="OutputSavedTrackerDataset" >
        <Tool Name="Probe"/>
        <Tool Name="Reference"/>
        <Tool Name="Stylus"/>
      </OutputStream>
    </Device>

    <Device Type="UsSimulator" Id="DeviceUsSimulator"
      AcquisitionRate="10"
      LocalTimeOffsetSec="0.0"
      UsImageOrientation="MF">
        <OutputStream Id="UsSimulatorOutput" BufferSize="200" AveragedItemsForFiltering="20"/>
    </Device>
    
    <Device Id="FinalMixer" Type="VirtualStreamMixer" Selectable="True">
      <OutputStream Id="Final"/>
      <InputStream Id="UsSimulatorOutput" />
      <InputStream Id="OutputSavedTrackerDataset" />
    </Device>
  </DataCollection>

  <CoordinateDefinitions>
    <Transform
      From="Image" To="Probe"
      Matrix="0.0       0.084     0.0        12.5
              -0.087    0.0       0.0        51.0
              0.0       0.0       0.087      -4.3    
              0         0         0          1"
      Error="1.0" Date="022412_120626" />
      
    <Transform
      From="Phantom" To="Reference" 
      Matrix="-0.0122295 0.0247489 -0.999619  10.661 
              -0.0104145 0.999636  0.0248767  -37.1121 
              0.999871   0.0107148 -0.0119673 -86.5167 
              0          0         0          1" 
      Error="0.965947" Date="022412_120626" />
  </CoordinateDefinitions> 


  <Rendering WorldCoordinateFrame="Reference">
    <DisplayableObject Type="Image" ObjectCoordinateFrame="Image" Id="LiveImage"/>
  <DisplayableObject Type="Model" ObjectCoordinateFrame="Reference" Id="Volume" />
  </Rendering>


  <fCal
    PhantomModelId="PhantomModel"
  ImageDisplayableObjectId="LiveImage"
  ReconstructedVolumeId="Volume"
    NumberOfStylusCalibrationPointsToAcquire="200"
    ImageCoordinateFrame="Image"
    ProbeCoordinateFrame="Probe"
    ReferenceCoordinateFrame="Reference"
    TransducerOriginCoordinateFrame="TransducerOrigin"
    TransducerOriginPixelCoordinateFrame="TransducerOriginPixel"
  />


  <vtkUsSimulatorAlgo
    BackgroundValue="155"
    ImageCoordinateFrame="Image"
    ReferenceCoordinateFrame="Phantom"
    FrameSize="820 616"
    SpacingMmPerPixel="1.0 1.0"

    ModelFileName="../TestImages/UsSimulatorAlgoTestModel.stl"
    ModelToReferenceTransform="
      1 0 0 0
      0 1 0 0
      0 0 1 0
      0 0 0 1"
  />

  <VolumeReconstruction
    OutputSpacing="1 1 1"
    ClipRectangleOrigin="0 0" ClipRectangleSize="820 616"
    Interpolation="LINEAR" Optimization="FULL" Compounding="On" FillHoles="Off"
  />

</PlusConfiguration>