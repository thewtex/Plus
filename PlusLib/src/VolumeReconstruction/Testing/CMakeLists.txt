SET( TestDataDir ${PLUSLIB_DATA_DIR}/TestImages )
SET( ConfigFilesDir ${PLUSLIB_DATA_DIR}/ConfigFiles )

#***************************  VolumeReconstructor  ***************************
ADD_EXECUTABLE(VolumeReconstructor VolumeReconstructor.cxx )
TARGET_LINK_LIBRARIES(VolumeReconstructor vtkVolumeReconstruction )

# Reconstruct a volume from brachy stepper acquisition
ADD_TEST(vtkVolumeReconstructorTest1
  ${EXECUTABLE_OUTPUT_PATH}/VolumeReconstructor
  --input-config-file-name=${ConfigFilesDir}/Testing/PlusConfiguration_VolumeReconstructionOnly_SonixRP_TRUS_D70mm.xml 
  --input-img-seq-file-name=${TestDataDir}/USTC_Ulterius_ProbeTranslationData.mha
  --output-volume-file-name=vtkVolumeReconstructorTest1Output.mha
  --input-transform-name=ImageToReference
  )
SET_TESTS_PROPERTIES( vtkVolumeReconstructorTest1 PROPERTIES FAIL_REGULAR_EXPRESSION "ERROR;WARNING" )

# Reconstruct a volume from freehand acquisition
ADD_TEST(vtkVolumeReconstructorTest2
  ${EXECUTABLE_OUTPUT_PATH}/VolumeReconstructor
  --input-config-file-name=${ConfigFilesDir}/Testing/PlusConfiguration_NwirePhantomFreehand_vtkVolumeReconstructorTest2.xml
  --input-img-seq-file-name=${TestDataDir}/NwirePhantomFreehand.mha
  --output-volume-file-name=vtkVolumeReconstructorTest2Output.mha
  --input-transform-name=ImageToReference
  )
SET_TESTS_PROPERTIES( vtkVolumeReconstructorTest2 PROPERTIES FAIL_REGULAR_EXPRESSION "ERROR;WARNING" )

# Compare reconstructed freehand volume (generated by vtkVolumeReconstructorTest2) with the reference volume
ADD_TEST(vtkVolumeReconstructorTest3
  ${CMAKE_COMMAND} -E compare_files 
  ${TestDataDir}/NwirePhantomFreehandReconstructed.mha
  vtkVolumeReconstructorTest2Output.mha
  )
SET_TESTS_PROPERTIES(vtkVolumeReconstructorTest3 PROPERTIES DEPENDS vtkVolumeReconstructorTest2)

# Reconstruct a volume from freehand acquisition and apply hole filling
ADD_TEST(vtkVolumeReconstructorWithHoleFillingTest1
  ${EXECUTABLE_OUTPUT_PATH}/VolumeReconstructor
  --input-config-file-name=${ConfigFilesDir}/Testing/PlusConfiguration_SpinePhantomFreehandReconstructionOnly.xml
  --input-img-seq-file-name=${TestDataDir}/SpinePhantomFreehand.mha
  --output-volume-file-name=vtkVolumeReconstructorWithHoleFillingTest1Output.mha
  --input-transform-name=ImageToReference
  )
SET_TESTS_PROPERTIES( vtkVolumeReconstructorWithHoleFillingTest1 PROPERTIES FAIL_REGULAR_EXPRESSION "ERROR;WARNING" )

# Compare reconstructed freehand volume (generated by vtkVolumeReconstructorTest2) with the reference volume
ADD_TEST(vtkVolumeReconstructorWithHoleFillingTest2
  ${CMAKE_COMMAND} -E compare_files 
  ${TestDataDir}/SpinePhantomFreehandReconstructed.mha
  vtkVolumeReconstructorWithHoleFillingTest1Output.mha
  )
SET_TESTS_PROPERTIES(vtkVolumeReconstructorWithHoleFillingTest2 PROPERTIES DEPENDS vtkVolumeReconstructorWithHoleFillingTest1)

# Reconstruct a volume from freehand acquisition using the maximum distribution
ADD_TEST(vtkVolumeReconstructorMaximum1
  ${EXECUTABLE_OUTPUT_PATH}/VolumeReconstructor
  --input-config-file-name=${ConfigFilesDir}/Testing/PlusConfiguration_SpinePhantomFreehandReconstructionOnlyMaximum.xml 
  --input-img-seq-file-name=${TestDataDir}/SpinePhantomFreehand.mha
  --output-volume-file-name=vtkVolumeReconstructorMaximum1Output.mha
  --input-transform-name=ImageToReference
  )
SET_TESTS_PROPERTIES( vtkVolumeReconstructorMaximum1 PROPERTIES FAIL_REGULAR_EXPRESSION "ERROR;WARNING" )

# Compare reconstructed freehand volume using maximum distribution (generated by vtkVolumeReconstructorMaximum1) with the reference volume
ADD_TEST(vtkVolumeReconstructorMaximum2
  ${CMAKE_COMMAND} -E compare_files 
  ${TestDataDir}/vtkVolumeReconstructorMaximum1OutputCompare.mha
  vtkVolumeReconstructorMaximum1Output.mha
  )
SET_TESTS_PROPERTIES(vtkVolumeReconstructorMaximum2 PROPERTIES DEPENDS vtkVolumeReconstructorMaximum1)

# Reconstruct a volume from freehand acquisition in floating point format
ADD_TEST(vtkVolumeReconstructorFloatType1
  ${EXECUTABLE_OUTPUT_PATH}/VolumeReconstructor
  --input-config-file-name=${ConfigFilesDir}/Testing/PlusConfiguration_SpinePhantomFreehandReconstructionOnly.xml
  --input-img-seq-file-name=${TestDataDir}/SpinePhantomFreehand3FramesFloat.mha
  --output-volume-file-name=vtkVolumeReconstructorFloatType1Output.mha
  --input-transform-name=ImageToReference
  )
SET_TESTS_PROPERTIES( vtkVolumeReconstructorFloatType1 PROPERTIES FAIL_REGULAR_EXPRESSION "ERROR;WARNING" )

# Compare reconstructed freehand volume using floating point format (generated by vtkVolumeReconstructorFloatType1) with the reference volume
ADD_TEST(vtkVolumeReconstructorFloatType2
  ${CMAKE_COMMAND} -E compare_files 
  ${TestDataDir}/vtkVolumeReconstructorFloatType1OutputCompare.mha
  vtkVolumeReconstructorFloatType1Output.mha
  )
SET_TESTS_PROPERTIES(vtkVolumeReconstructorFloatType2 PROPERTIES DEPENDS vtkVolumeReconstructorFloatType1)

#***************************  CreateSliceModels  ***************************
# This program helps debugging geometry problems in volume reconstruction.
ADD_EXECUTABLE( CreateSliceModels CreateSliceModels.cxx )
TARGET_LINK_LIBRARIES( CreateSliceModels vtkPlusCommon vtkVolumeReconstruction )
ADD_TEST(CreateSliceModelsTest 
  ${EXECUTABLE_OUTPUT_PATH}/CreateSliceModels
  --input-metafile=${TestDataDir}/NwirePhantomFreehand.mha
  --output-modelfile=GeneratedSliceModels.mha  
  --input-configfile=${ConfigFilesDir}/Testing/PlusConfiguration_NwirePhantomFreehand_vtkVolumeReconstructorTest2.xml
  --image-to-reference-transform-name=ProbeToReference
  )
SET_TESTS_PROPERTIES( CreateSliceModelsTest PROPERTIES FAIL_REGULAR_EXPRESSION "ERROR;WARNING" )

#***************************  CompareVolumes  ***************************
# This program compares two volumes and outputs difference statistics
ADD_EXECUTABLE( CompareVolumes CompareVolumes.cxx vtkCompareVolumes.cxx )
TARGET_LINK_LIBRARIES( CompareVolumes vtkPlusCommon )

# --------------------------------------------------------------------------
# Install
#

INSTALL(TARGETS VolumeReconstructor CreateSliceModels
  DESTINATION bin
  COMPONENT RuntimeExecutables
  )
