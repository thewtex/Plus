% Computes 64-bit CRC according to ECMA-182 standard.
% Implementation based on OpenIGTLink library's igtl_util.c
% TODO: this only works if the input is an 8-byte floating point number!
function crc64=computeCrc64(inData,crc64in)  

    % Create a helper table for CRC computation and store it in a global
    % variable for reuse
    global igtlCrcTable
    if ~exist('igtlCrcTable', 'var') || isempty(igtlCrcTable)
        igtlCrcTable = [
            hex2uint64('0000000000000000'), hex2uint64('42F0E1EBA9EA3693'), ... 
            hex2uint64('85E1C3D753D46D26'), hex2uint64('C711223CFA3E5BB5'), ...
            hex2uint64('493366450E42ECDF'), hex2uint64('0BC387AEA7A8DA4C'), ...
            hex2uint64('CCD2A5925D9681F9'), hex2uint64('8E224479F47CB76A'), ...
            hex2uint64('9266CC8A1C85D9BE'), hex2uint64('D0962D61B56FEF2D'), ...
            hex2uint64('17870F5D4F51B498'), hex2uint64('5577EEB6E6BB820B'), ...
            hex2uint64('DB55AACF12C73561'), hex2uint64('99A54B24BB2D03F2'), ...
            hex2uint64('5EB4691841135847'), hex2uint64('1C4488F3E8F96ED4'), ...
            hex2uint64('663D78FF90E185EF'), hex2uint64('24CD9914390BB37C'), ...
            hex2uint64('E3DCBB28C335E8C9'), hex2uint64('A12C5AC36ADFDE5A'), ...
            hex2uint64('2F0E1EBA9EA36930'), hex2uint64('6DFEFF5137495FA3'), ...
            hex2uint64('AAEFDD6DCD770416'), hex2uint64('E81F3C86649D3285'), ...
            hex2uint64('F45BB4758C645C51'), hex2uint64('B6AB559E258E6AC2'), ...
            hex2uint64('71BA77A2DFB03177'), hex2uint64('334A9649765A07E4'), ...
            hex2uint64('BD68D2308226B08E'), hex2uint64('FF9833DB2BCC861D'), ...
            hex2uint64('388911E7D1F2DDA8'), hex2uint64('7A79F00C7818EB3B'), ...
            hex2uint64('CC7AF1FF21C30BDE'), hex2uint64('8E8A101488293D4D'), ...
            hex2uint64('499B3228721766F8'), hex2uint64('0B6BD3C3DBFD506B'), ...
            hex2uint64('854997BA2F81E701'), hex2uint64('C7B97651866BD192'), ...
            hex2uint64('00A8546D7C558A27'), hex2uint64('4258B586D5BFBCB4'), ...
            hex2uint64('5E1C3D753D46D260'), hex2uint64('1CECDC9E94ACE4F3'), ...
            hex2uint64('DBFDFEA26E92BF46'), hex2uint64('990D1F49C77889D5'), ...
            hex2uint64('172F5B3033043EBF'), hex2uint64('55DFBADB9AEE082C'), ...
            hex2uint64('92CE98E760D05399'), hex2uint64('D03E790CC93A650A'), ...
            hex2uint64('AA478900B1228E31'), hex2uint64('E8B768EB18C8B8A2'), ...
            hex2uint64('2FA64AD7E2F6E317'), hex2uint64('6D56AB3C4B1CD584'), ...
            hex2uint64('E374EF45BF6062EE'), hex2uint64('A1840EAE168A547D'), ...
            hex2uint64('66952C92ECB40FC8'), hex2uint64('2465CD79455E395B'), ...
            hex2uint64('3821458AADA7578F'), hex2uint64('7AD1A461044D611C'), ...
            hex2uint64('BDC0865DFE733AA9'), hex2uint64('FF3067B657990C3A'), ...
            hex2uint64('711223CFA3E5BB50'), hex2uint64('33E2C2240A0F8DC3'), ...
            hex2uint64('F4F3E018F031D676'), hex2uint64('B60301F359DBE0E5'), ...
            hex2uint64('DA050215EA6C212F'), hex2uint64('98F5E3FE438617BC'), ...
            hex2uint64('5FE4C1C2B9B84C09'), hex2uint64('1D14202910527A9A'), ...
            hex2uint64('93366450E42ECDF0'), hex2uint64('D1C685BB4DC4FB63'), ...
            hex2uint64('16D7A787B7FAA0D6'), hex2uint64('5427466C1E109645'), ...
            hex2uint64('4863CE9FF6E9F891'), hex2uint64('0A932F745F03CE02'), ...
            hex2uint64('CD820D48A53D95B7'), hex2uint64('8F72ECA30CD7A324'), ...
            hex2uint64('0150A8DAF8AB144E'), hex2uint64('43A04931514122DD'), ...
            hex2uint64('84B16B0DAB7F7968'), hex2uint64('C6418AE602954FFB'), ...
            hex2uint64('BC387AEA7A8DA4C0'), hex2uint64('FEC89B01D3679253'), ...
            hex2uint64('39D9B93D2959C9E6'), hex2uint64('7B2958D680B3FF75'), ...
            hex2uint64('F50B1CAF74CF481F'), hex2uint64('B7FBFD44DD257E8C'), ...
            hex2uint64('70EADF78271B2539'), hex2uint64('321A3E938EF113AA'), ...
            hex2uint64('2E5EB66066087D7E'), hex2uint64('6CAE578BCFE24BED'), ...
            hex2uint64('ABBF75B735DC1058'), hex2uint64('E94F945C9C3626CB'), ...
            hex2uint64('676DD025684A91A1'), hex2uint64('259D31CEC1A0A732'), ...
            hex2uint64('E28C13F23B9EFC87'), hex2uint64('A07CF2199274CA14'), ...
            hex2uint64('167FF3EACBAF2AF1'), hex2uint64('548F120162451C62'), ...
            hex2uint64('939E303D987B47D7'), hex2uint64('D16ED1D631917144'), ...
            hex2uint64('5F4C95AFC5EDC62E'), hex2uint64('1DBC74446C07F0BD'), ...
            hex2uint64('DAAD56789639AB08'), hex2uint64('985DB7933FD39D9B'), ...
            hex2uint64('84193F60D72AF34F'), hex2uint64('C6E9DE8B7EC0C5DC'), ...
            hex2uint64('01F8FCB784FE9E69'), hex2uint64('43081D5C2D14A8FA'), ...
            hex2uint64('CD2A5925D9681F90'), hex2uint64('8FDAB8CE70822903'), ...
            hex2uint64('48CB9AF28ABC72B6'), hex2uint64('0A3B7B1923564425'), ...
            hex2uint64('70428B155B4EAF1E'), hex2uint64('32B26AFEF2A4998D'), ...
            hex2uint64('F5A348C2089AC238'), hex2uint64('B753A929A170F4AB'), ...
            hex2uint64('3971ED50550C43C1'), hex2uint64('7B810CBBFCE67552'), ...
            hex2uint64('BC902E8706D82EE7'), hex2uint64('FE60CF6CAF321874'), ...
            hex2uint64('E224479F47CB76A0'), hex2uint64('A0D4A674EE214033'), ...
            hex2uint64('67C58448141F1B86'), hex2uint64('253565A3BDF52D15'), ...
            hex2uint64('AB1721DA49899A7F'), hex2uint64('E9E7C031E063ACEC'), ...
            hex2uint64('2EF6E20D1A5DF759'), hex2uint64('6C0603E6B3B7C1CA'), ...
            hex2uint64('F6FAE5C07D3274CD'), hex2uint64('B40A042BD4D8425E'), ...
            hex2uint64('731B26172EE619EB'), hex2uint64('31EBC7FC870C2F78'), ...
            hex2uint64('BFC9838573709812'), hex2uint64('FD39626EDA9AAE81'), ...
            hex2uint64('3A28405220A4F534'), hex2uint64('78D8A1B9894EC3A7'), ...
            hex2uint64('649C294A61B7AD73'), hex2uint64('266CC8A1C85D9BE0'), ...
            hex2uint64('E17DEA9D3263C055'), hex2uint64('A38D0B769B89F6C6'), ...
            hex2uint64('2DAF4F0F6FF541AC'), hex2uint64('6F5FAEE4C61F773F'), ...
            hex2uint64('A84E8CD83C212C8A'), hex2uint64('EABE6D3395CB1A19'), ...
            hex2uint64('90C79D3FEDD3F122'), hex2uint64('D2377CD44439C7B1'), ...
            hex2uint64('15265EE8BE079C04'), hex2uint64('57D6BF0317EDAA97'), ...
            hex2uint64('D9F4FB7AE3911DFD'), hex2uint64('9B041A914A7B2B6E'), ...
            hex2uint64('5C1538ADB04570DB'), hex2uint64('1EE5D94619AF4648'), ...
            hex2uint64('02A151B5F156289C'), hex2uint64('4051B05E58BC1E0F'), ...
            hex2uint64('87409262A28245BA'), hex2uint64('C5B073890B687329'), ...
            hex2uint64('4B9237F0FF14C443'), hex2uint64('0962D61B56FEF2D0'), ...
            hex2uint64('CE73F427ACC0A965'), hex2uint64('8C8315CC052A9FF6'), ...
            hex2uint64('3A80143F5CF17F13'), hex2uint64('7870F5D4F51B4980'), ...
            hex2uint64('BF61D7E80F251235'), hex2uint64('FD913603A6CF24A6'), ...
            hex2uint64('73B3727A52B393CC'), hex2uint64('31439391FB59A55F'), ...
            hex2uint64('F652B1AD0167FEEA'), hex2uint64('B4A25046A88DC879'), ...
            hex2uint64('A8E6D8B54074A6AD'), hex2uint64('EA16395EE99E903E'), ...
            hex2uint64('2D071B6213A0CB8B'), hex2uint64('6FF7FA89BA4AFD18'), ...
            hex2uint64('E1D5BEF04E364A72'), hex2uint64('A3255F1BE7DC7CE1'), ...
            hex2uint64('64347D271DE22754'), hex2uint64('26C49CCCB40811C7'), ...
            hex2uint64('5CBD6CC0CC10FAFC'), hex2uint64('1E4D8D2B65FACC6F'), ...
            hex2uint64('D95CAF179FC497DA'), hex2uint64('9BAC4EFC362EA149'), ...
            hex2uint64('158E0A85C2521623'), hex2uint64('577EEB6E6BB820B0'), ...
            hex2uint64('906FC95291867B05'), hex2uint64('D29F28B9386C4D96'), ...
            hex2uint64('CEDBA04AD0952342'), hex2uint64('8C2B41A1797F15D1'), ...
            hex2uint64('4B3A639D83414E64'), hex2uint64('09CA82762AAB78F7'), ...
            hex2uint64('87E8C60FDED7CF9D'), hex2uint64('C51827E4773DF90E'), ...
            hex2uint64('020905D88D03A2BB'), hex2uint64('40F9E43324E99428'), ...
            hex2uint64('2CFFE7D5975E55E2'), hex2uint64('6E0F063E3EB46371'), ...
            hex2uint64('A91E2402C48A38C4'), hex2uint64('EBEEC5E96D600E57'), ...
            hex2uint64('65CC8190991CB93D'), hex2uint64('273C607B30F68FAE'), ...
            hex2uint64('E02D4247CAC8D41B'), hex2uint64('A2DDA3AC6322E288'), ...
            hex2uint64('BE992B5F8BDB8C5C'), hex2uint64('FC69CAB42231BACF'), ...
            hex2uint64('3B78E888D80FE17A'), hex2uint64('7988096371E5D7E9'), ...
            hex2uint64('F7AA4D1A85996083'), hex2uint64('B55AACF12C735610'), ...
            hex2uint64('724B8ECDD64D0DA5'), hex2uint64('30BB6F267FA73B36'), ...
            hex2uint64('4AC29F2A07BFD00D'), hex2uint64('08327EC1AE55E69E'), ...
            hex2uint64('CF235CFD546BBD2B'), hex2uint64('8DD3BD16FD818BB8'), ...
            hex2uint64('03F1F96F09FD3CD2'), hex2uint64('41011884A0170A41'), ...
            hex2uint64('86103AB85A2951F4'), hex2uint64('C4E0DB53F3C36767'), ...
            hex2uint64('D8A453A01B3A09B3'), hex2uint64('9A54B24BB2D03F20'), ...
            hex2uint64('5D45907748EE6495'), hex2uint64('1FB5719CE1045206'), ...
            hex2uint64('919735E51578E56C'), hex2uint64('D367D40EBC92D3FF'), ...
            hex2uint64('1476F63246AC884A'), hex2uint64('568617D9EF46BED9'), ...
            hex2uint64('E085162AB69D5E3C'), hex2uint64('A275F7C11F7768AF'), ...
            hex2uint64('6564D5FDE549331A'), hex2uint64('279434164CA30589'), ...
            hex2uint64('A9B6706FB8DFB2E3'), hex2uint64('EB46918411358470'), ...
            hex2uint64('2C57B3B8EB0BDFC5'), hex2uint64('6EA7525342E1E956'), ...
            hex2uint64('72E3DAA0AA188782'), hex2uint64('30133B4B03F2B111'), ...
            hex2uint64('F7021977F9CCEAA4'), hex2uint64('B5F2F89C5026DC37'), ...
            hex2uint64('3BD0BCE5A45A6B5D'), hex2uint64('79205D0E0DB05DCE'), ...
            hex2uint64('BE317F32F78E067B'), hex2uint64('FCC19ED95E6430E8'), ...
            hex2uint64('86B86ED5267CDBD3'), hex2uint64('C4488F3E8F96ED40'), ...
            hex2uint64('0359AD0275A8B6F5'), hex2uint64('41A94CE9DC428066'), ...
            hex2uint64('CF8B0890283E370C'), hex2uint64('8D7BE97B81D4019F'), ...
            hex2uint64('4A6ACB477BEA5A2A'), hex2uint64('089A2AACD2006CB9'), ...
            hex2uint64('14DEA25F3AF9026D'), hex2uint64('562E43B4931334FE'), ...
            hex2uint64('913F6188692D6F4B'), hex2uint64('D3CF8063C0C759D8'), ...
            hex2uint64('5DEDC41A34BBEEB2'), hex2uint64('1F1D25F19D51D821'), ...
            hex2uint64('D80C07CD676F8394'), hex2uint64('9AFCE626CE85B507') ];
    end

    data = typecast(inData,'uint8'); % TODO: this only works if the input is an 8-byte floating point number
    
    crc64=uint64(crc64in);
    for k=length(data):-1:1 % TODO: this only works if the input is an 8-byte floating point number
        % crc = table[data(k) ^ (unsigned char)(crc >> 56)] ^ (crc << 8);        
        crc64 = bitxor(igtlCrcTable(1+bitxor(uint64(data(k)),mod(bitshift(crc64,-56),256))),bitshift(crc64,8));
    end
end

% Works similar to HEX2DEC but does not support multiple rows.
% Source: http://www.mathworks.com/matlabcentral/fileexchange/26005-convert-a-number-in-hex-to-uint64/content/hex2uint64.m
function y=hex2uint64(x)   
    v=zeros(1,16);
    y=uint64(0);
    nibble=0;
    for i=length(x):-1:1
        v=uint64(hex2dec(x(i)));
        v=bitshift(v,nibble);
        y=bitor(y,v);
        nibble=nibble+4;
    end
end
